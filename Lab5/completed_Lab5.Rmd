---
title: "Lab 5 new"
author: "Seth Michael Woodbury"
date: "10/07/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Desktop/UMich_Bio201_F19/")
```

# Load packages

```{r Load packages, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(readxl)
library(broom)
library(cowplot)
library(agricolae)
set.seed(7)
```

# Relationship between data structure and results
There are several factors of data sets which influence the results of statistical tests: 

* Values: numeric values of each data point
* Sample size (n): number of data points in each group being compared 
* Variance: spread of the data within each group
* Effect size: size of the difference in mean, strength of the correlation, etc. 

Before getting into the details of use and interpretation of formal statistical tests, we are going to do an exercise with random number vectors to illustrate how each of these factors effects your intuitive interpretation of the results. 

Run the code blocks below to create two vectors with the listed means, sample size, variation (via SD). Combine these vectors into a data frame and plot. Discuss with your neighbor, then under each plot write if you would determine these two samples to be equal, and which factors influenced your decision. 

### Example 1
```{r}
sample1 <- rnorm(6, mean=12, sd = 1) #vector1 

sample2 <- rnorm(6, mean=15, sd = 1) #vector2 

df1 <- cbind(sample1, sample2) %>% #combine vectors into dataframe
  as.data.frame() %>% 
  gather(key = "samples", value = "numbers") %>% #make long format
  mutate(samples = as.factor(samples)) #convert to factor for plot

ggplot(data = df1, aes(x = samples, #plot data frame 
                     y = numbers)) + 
  geom_boxplot(aes(color = samples)) + #shows median & quartiles 
  geom_jitter(aes(color = samples)) + #jitter = individual points per category 
  theme(legend.position = "none")
```

# I do not believe these data sets are equal but it is a little hard to tell. The interquartile ranges do not overlap (by a pretty significant gap) but the max of sample one is very close to the minimum of sample 2. N is very small, so in the real world this data might not be enough evidence (because of the two outliers in sample 1) to say these data are distinctly different, but for the purposes of our excerise, they do not appear to be the same. Ideally, we would increase n to prove that the outliers in sample 1 are just outliers, because when 2/7 points are dramatically higher, it raises suspicion and caution about the data variation.

### Example 2
```{r}
sample3 <- rnorm(6, mean=12, sd = 3) 
sample4 <- rnorm(6, mean=15, sd = 4) 

df2 <- cbind(sample3, sample4) %>% #combine vectors into dataframe
  as.data.frame() %>% 
  gather(key = "samples", value = "numbers") %>% #make long format
  mutate(samples = as.factor(samples)) #convert to factor for plot

ggplot(data = df2, aes(x = samples, #plot data frame 
                     y = numbers)) + 
  geom_boxplot(aes(color = samples)) + 
  geom_jitter(aes(color = samples)) + 
  theme(legend.position = "none")
```
#There is not enough evidence to disprove the hypothesis that these data sets are different. In fact, there is a lot of evidence to prove they are the same: both have overlapping interquartile ranges (overlapping boxes) which means they have a lot of similarity in where the data points tend to lie. However, it is noteworthy that there is a lot of varience for both sets and n is small, so these are not super accurate boxplots, so more sampling is needed. For now we have more evidence to believe the null hypothesis (the data sets are equal) than to prove it wrong.




### Example 3
```{r}
sample5 <- rnorm(20, mean=12, sd = 1) 
sample6 <- rnorm(20, mean=15, sd = 1) 

df3 <- cbind(sample5, sample6) %>% #combine vectors into dataframe
  as.data.frame() %>% 
  gather(key = "samples", value = "numbers") %>% #make long format
  mutate(samples = as.factor(samples)) #convert to factor for plot

ggplot(data = df3, aes(x = samples, #plot data frame 
                     y = numbers)) + 
  geom_boxplot(aes(color = samples)) + 
  geom_jitter(aes(color = samples)) + 
  theme(legend.position = "none")
```

#Because our sample size "n" is large, we have more reliable data and the spread of the data is not so large. The two box plots appear to not intersect the same numbers at any points so it is relatively reasonable to assume these data sets are not the same and reject the null hypothesis.



### Example 4
```{r}
sample7 <- rnorm(20, mean=12, sd = 3) 
sample8 <- rnorm(20, mean=15, sd = 4) 

df4 <- cbind(sample7, sample8) %>% #combine vectors into dataframe
  as.data.frame() %>% 
  gather(key = "samples", value = "numbers") %>% #make long format
  mutate(samples = as.factor(samples)) #convert to factor for plot

ggplot(data = df4, aes(x = samples, #plot data frame 
                     y = numbers)) + 
  geom_boxplot(aes(color = samples)) + 
  geom_jitter(aes(color = samples)) + 
  theme(legend.position = "none")
```
# Although n is large, the data has a lot of spread and both boxplots intersect with with each and have many overlapping data points. Clearly we have almost no evidence to reject the null hypothesis so in this case we must accept it and thus assume the data sets are the same.

# Import data 

Import the data frame you generated last week that has the mean weekly SCFAs. Import both long and wide formats of these data. During import convert column names to snake case.  
```{r include=FALSE}
scfa_long <- read_delim("Lab5/curated_data/SCFA_wkly_long.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower) %>%
  mutate(semester = factor(semester,
                           levels=c("Winter2015", "Fall2015", 
                                    "Winter2016", "Fall2016", 
                                    "Winter2017", "Fall2017", 
                                    "Winter2018", "Fall2018", 
                                    "Winter2019"), ordered = TRUE))
  

scfa_wide <- read_delim("Lab5/curated_data/SCFA_wkly_wide.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower) %>%
  mutate(semester = factor(semester,
                           levels=c("Winter2015", "Fall2015", 
                                    "Winter2016", "Fall2016", 
                                    "Winter2017", "Fall2017", 
                                    "Winter2018", "Fall2018", 
                                    "Winter2019"), ordered = TRUE))

```


# Introduction

As mentioned earlier this semester, one of the over arching questions for this course is: "Does the consumption of a prebiotic (fiber supplement) affect the gut microbiome?" As you have been learning there are many elements to this; fermentation products, community composition, pH, and host lifestyle. In most of the lab exercise today we will attempt to answer part of this question using the change in fermentation products (specifically butyrate) in individuals who consumed potato starch. Today we will introduce several types of plots, and discuss when they are appropriate for certain families of data, and we will conduct some basic statistical tests for these plots. 

```{r}
# use select + starts_with or ends_with to retain/drop multiple columns with similar names
butyrate_wide <- scfa_wide %>%
  select(-starts_with("ace"), -ends_with("ace"), 
         -starts_with("pro"), -ends_with("pro"),
         -starts_with("total"), -ends_with("total"),
         -starts_with("delta")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS" | supplement_consumed == "LOODAT") %>%
  na.omit(but_wk1, but_wk3)

```

# 1 continuous and 1 categorical (discrete) variable 

In this lesson we are going to use the term categorical, however these are called discrete on the ggplot cheatsheet. 

### Violin plots
In the section above we subset by fiber supplement and fermentation product. One of the variations of fiber supplement we tested was frequency (once or twice daily). In the code below we are going to generate a plot that illustrates the butyrate concentration when individuals are consuming fiber supplements at different frequencies. 

Violin plots (or geom_boxplot + geom_jitter) are the recommended way to represent these families of data, they show the variation and the range, are easy to annotate with a mean (geom_errobar), you can easily add individual data points (geom_violin + geom_jitter), and do not obfuscate data in the manner of a bar plot. We will not use bar plots in this course. 

Subset the long data frame imported above for butyrate measurements only, supplement type is potato starch (BRMPS or LOODAT), drop any samples from Winter 2015, filter for individuals who were quantity compliant, make sure to keep the frequency and semester columns. 
```{r}
butyrate_long <- scfa_long %>%
  select(-starts_with("ace"), -starts_with("pro"), -ends_with("median")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS" | supplement_consumed == "LOODAT",
         quantity_compliant == "yes") %>%
  na.omit(butyrate_mean) #drop any samples with NA in named columns

# Generate a plot of the [butyrate] of each supplement type, week 3 only  
butyrate_long %>%
  filter(study_week == "week3") %>%
  ggplot(aes(x = frequency, 
             y = butyrate_mean)) + 
  geom_violin() # + geom_jitter()
```

In the plots created above, notice the widest part of the twice daily category appears slightly higher than once daily. This means most of the data points in the 2x group are of a higher concentration that those in the 1x group. However the top of the violin in the 1x group is higher than the 2x, indicating the 1x group's maximum value is greater. Discuss with your neighbor, do you think the butyrate concentrations of these two groups (1x vs. 2x) are different? 

#The distributions are certainly different. The 1x is more "normal" because it has one mean but it is skewed towards the top and has a larger range than the 2xdaily. Yet, the 2x daily is bimodal and both of those means are higher than the 1x daily, so the 2xdaily group does tend to have higher butyrate concentrations but it is hard to really make conclusions here since we aren't comparing 2 normal data plots.

### Checking assumptions
In the sections above we observed trends in the data, but this is not sufficient for research purposes. Scientists use statistics to determine the probability that these trends are real. Before we can dive into using a statistical test, we have to determine if our data are appropriate for the test of interest, otherwise we might have more confidence in the results than we should. We do this by checking the assumptions of the tests. 

In the violin plot above, we want to determine if the butyrate concentrations in 1xdaily potato starch consumers is different from that of the 2xdaily potato starch consumers. The plot indicates this might be the case. To answer this question we are comparing two means, to do this we use the student's t-test. A t-test requires the following assumptions to be met: 

* Relatively large sample size (usually > 30)
* The samples have to come from a normal distribution
* We are also going to check if the variances of the groups are equal, because this will determine some of the t.test() arguments

##### Sample size
```{r}
# check sample size
butyrate_long %>%
  filter(study_week == "week3") %>% #subset long data frame in same manner as for plot
  group_by(frequency) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group
```

##### Normality 
```{r}
# normal distribution 
but_df <- butyrate_long %>%
  filter(study_week == "week3") #subset long data frame in same manner as for plot

shapiro.test(but_df$butyrate_mean) #call column of df with values = vector 

```
Here a small p-value indicates these samples differ from a normal distribution. When I have a result with a samll p-value I always check how much the distrubtion deviates from normal with a histogram:

```{r}
ggplot(but_df, aes(x=butyrate_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value

qqnorm(but_df$butyrate_mean); qqline(but_df$butyrate_mean)
```
This histogram shows a rough bell curve, in combination with our large sample size we are okay with proceeding with a t-test. 

#### Equal variances 
Finally we are going to determine if the groups we would like to compare (1xdaily and 2xdaily) have equal variances (homogeneity). 
```{r}
# code to extract first group (1xdaily)
once_grp <- butyrate_long %>%
  filter(study_week == "week3",
         frequency == "1xdaily") 

# code to extract second group (2xdaily)
twice_grp <- butyrate_long %>%
  filter(study_week == "week3",
         frequency == "2xdaily") 
```

```{r}
var.test(x = once_grp$butyrate_mean, 
         y = twice_grp$butyrate_mean, 
         alternative = "two.sided")
```
A low p-value indicates the variances are not equal, we will account for this in our test in the next section. 

### T-test between categorical variables
The test you will probably use most frequently is the t-test; and this test determines if the means of two groups are equal. First we need to extract the data we will use for the test: 

```{r}
# use groups extracted above for the test 
t.test(x = once_grp$butyrate_mean, 
       y = twice_grp$butyrate_mean,
       alternative = "less", paired = FALSE, var.equal = FALSE)
```
A large p-value indicates the means of the two groups are not different. 

### Paired t-test
As we've discussed in Friday lectures, everyone has a unique microbiome. We should compare week 1 and week 3 concentrations of all individuals who consumed BRMPS, and determine if the addition of the supplement results in generally higher fecal butyrate concentrations for most individuals. This is accomplished with a special flavor of t-test called a paired t-test. Paired t-tests are used whenever the samples are not independent, such as when the samples are from the same individual over time. 

```{r}
# Same plot as above but use facets to plot both weeks 
butyrate_long %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>% 
  ggplot(aes(x = study_week, 
             y = butyrate_mean, 
             color = study_week), 
         frequency) + 
  geom_violin() + # geom_jitter() + 
  facet_grid(~frequency) + 
  xlab(NULL) + 
  ylab("Butyrate (mmol/kg)") + 
  theme(legend.position = "none")
```
In the figure above it appears there is no difference in weeks for the 1xdaily group, but there may be an increase in the 2xdaily group. 

Before we conduct the statistical test to determine if the observed trends are likely true, we must check our assumptions.
```{r}
# sample size
butyrate_long %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>%  #subset long data frame in same manner as plot
  group_by(frequency, study_week) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group
```

```{r}
# Check assumptions for each week of the 2xdaily groups 
wk1_2x <- butyrate_long %>%
  filter(study_week == "week1", 
         supplement_consumed == "BRMPS", 
         frequency == "2xdaily") 
shapiro.test(wk1_2x$butyrate_mean) 
ggplot(wk1_2x, aes(x = butyrate_mean)) + geom_histogram()

wk3_2x <- butyrate_long %>%
  filter(study_week == "week3", 
         supplement_consumed == "BRMPS", 
         frequency == "2xdaily") 
shapiro.test(wk3_2x$butyrate_mean) 
ggplot(wk3_2x, aes(x = butyrate_mean)) + geom_histogram()

# join these data frames back together
x2_df <- inner_join(x = wk1_2x, y = wk3_2x,
                    by = c("participant_id", "frequency", 
                           "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(butyrate_mean_wk1 = butyrate_mean.x,
         butyrate_mean_wk3 = butyrate_mean.y) %>%
  select(-starts_with("study_week"))

# code to run paired t-test 
t.test(x = x2_df$butyrate_mean_wk1, y = x2_df$butyrate_mean_wk3, 
       alternative = "less", paired = TRUE) 
```
For this paired t-test we specified alternative = less because we expect the butyrate concentrations to be higher during week 3. Read the details of the t.test() help page for options for the alternative argument.

The p-value is 0.07 which for a complex biological system (like the gut microbiome) is low! The pattern we observed in the figure is likely a real trend. We can say with confidence that the butyrate concentrations between weeks 1 and 3 are not equal for individuals who consumed BRMPS twice daily. 

### Non-parametric test
What if our data set does not meet any of the assumptions for the test? We just use another test. A t-test is a parametric test, and the non-parametric counterpart is the Mann-Whitney-U test (also called a two-sample Wilcoxon test).
```{r}
# same arguments, just a different function call. 
wilcox.test(x = x2_df$butyrate_mean_wk1, 
            y = x2_df$butyrate_mean_wk3, 
            alternative = "less", paired = TRUE)
```

# Homework 5.1
Repeat the process to conduct the paired t-test for the 1xdaily group. Remember to check the assumptions. Write your conclusions regarding the test as a comment at the end of the code block. 
  Checking Assumption that n > 30
```{r}
# sample size
butyrate_long %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>%  #subset long data frame in same manner as plot
  group_by(frequency, study_week) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group

```
n is greater than 30 for the 1xdaily group in both weeks so that assumption so we may procede with testing the other assumptions.

```{r}
# copy + paste code, and update column and dataframes names to run test
# Check assumptions for each week of the 1xdaily groups 
wk1_1x <- butyrate_long %>%
  filter(study_week == "week1", 
         supplement_consumed == "BRMPS", 
         frequency == "1xdaily") 
shapiro.test(wk1_1x$butyrate_mean) 
ggplot(wk1_1x, aes(x = butyrate_mean)) + geom_histogram()

wk3_1x <- butyrate_long %>%
  filter(study_week == "week3", 
         supplement_consumed == "BRMPS", 
         frequency == "1xdaily") 
shapiro.test(wk3_1x$butyrate_mean) 
ggplot(wk3_1x, aes(x = butyrate_mean)) + geom_histogram()

# varience test
var.test(x = wk1_1x$butyrate_mean, 
         y = wk3_1x$butyrate_mean, 
         alternative = "two.sided")


# join these data frames back together
x1_df <- inner_join(x = wk1_1x, y = wk3_1x,
                    by = c("participant_id", "frequency", 
                           "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(butyrate_mean_wk1 = butyrate_mean.x,
         butyrate_mean_wk3 = butyrate_mean.y) %>%
  select(-starts_with("study_week"))

# code to run paired t-test 
t.test(x = x1_df$butyrate_mean_wk1, y = x1_df$butyrate_mean_wk3, 
       alternative = "less", paired = TRUE) 
```
# Fortunately, most assumptions can be confirmed, as our sample size is way greater than 30 for each week, and the variences of the weeks can be assumed equal (p-value = .6407) due to the high p - value However, we do not have normal data for both weeks since the Shapiro-tests have an incredibly low p-value for each week; we can get around this because our histogram appears to look normal, so although we must proceed with caution it is fairly reasonable to assume these data to be approximately normal. Since our assumptions are reasonably met we conduct the test and see that the p-value for the actual paired t-test is .2367, which is a fairly high chance that these results could happen if our null hypothesis is true. In other words, we do not have a small enough p-value to reject our null hypothesis, so we must conclude that consuming BRMPS once a day in the portion size that particpants in the study took, will not have any effect on the human microbiome production of butyrate.

# Homework 5.2
Generate plots to determine if methane, acetate, propionate increased during week 3 of the study. Generate plot to determine if pH decreased during week 3 of the study. Save plots to folder called `figures`. 
```{r}
# breath methane
breath_gas <- read_delim("Lab5/curated_data/breath_wkly.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower) %>%
  mutate(semester = factor(semester,
                           levels=c("Winter2015", "Fall2015", 
                                    "Winter2016", "Fall2016", 
                                    "Winter2017", "Fall2017", 
                                    "Winter2018", "Fall2018", 
                                    "Winter2019"), ordered = TRUE))
breath_methane <- breath_gas %>%
  select(-starts_with("h2"), -ends_with("h2"), 
         -starts_with("co2"), -ends_with("median"),
         -starts_with("comm"),
         -starts_with("n_meas")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS" | supplement_consumed == "LOODAT",
         quantity_compliant == "yes") %>%
  na.omit(ch4_mean) #drop any samples with NA in named columns

breath_methane %>%
  filter(study_week == "week1" | study_week == "week3") %>%
  ggplot(aes(x = study_week, 
             y = ch4_mean)) + 
  geom_violin() # + geom_jitter()
breath_methane

ggsave2(breath_methane, path = "~/Desktop/UMich_Bio201_F19/figures/")



# Facet Grid (ignore)
breath_methane %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>% 
  ggplot(aes(x = study_week, 
             y = ch4_mean, 
             color = study_week), 
         frequency) + 
  geom_violin() + # geom_jitter() + 
  facet_grid(~frequency) + 
  xlab(NULL) + 
  ylab("Methane (mmol/kg)") + 
  theme(legend.position = "none")
```

```{r}
# acetate
acetate_long <- scfa_long %>%
  select(-starts_with("but"), -starts_with("pro"), -ends_with("median")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS" | supplement_consumed == "LOODAT",
         quantity_compliant == "yes") %>%
  na.omit(butyrate_mean) #drop any samples with NA in named columns

# Generate a plot of the [acetate] of each supplement type, week 3 only  
acetate_long %>%
  filter(study_week == "week1" | study_week == "week3") %>%
  ggplot(aes(x = study_week, 
             y = acetate_mean)) + 
  geom_violin() # + geom_jitter()
acetate_long


ggsave2(acetate_long, path = "~/Desktop/UMich_Bio201_F19/figures/")


# Facet Grid (ignore)
acetate_long %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>% 
  ggplot(aes(x = study_week, 
             y = acetate_mean, 
             color = study_week), 
         frequency) + 
  geom_violin() + # geom_jitter() + 
  facet_grid(~frequency) + 
  xlab(NULL) + 
  ylab("Acetate (mmol/kg)") + 
  theme(legend.position = "none")
```

```{r}
# propionate
propionate_long <- scfa_long %>%
  select(-starts_with("but"), -starts_with("ace"), -ends_with("median")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS" | supplement_consumed == "LOODAT",
         quantity_compliant == "yes") %>%
  na.omit(propionate_mean) #drop any samples with NA in named columns

# Generate a plot of the [acetate] of each supplement type, week 3 only  
propionate_long %>%
  filter(study_week == "week1" | study_week == "week3") %>%
  ggplot(aes(x = study_week, 
             y = propionate_mean)) + 
  geom_violin() # + geom_jitter()
propionate_long

ggsave2(propionate_long, path = "~/Desktop/UMich_Bio201_F19/figures/")

# Facet Grid (ignore)
propionate_long %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>% 
  ggplot(aes(x = study_week, 
             y = propionate_mean, 
             color = study_week), 
         frequency) + 
  geom_violin() + # geom_jitter() + 
  facet_grid(~frequency) + 
  xlab(NULL) + 
  ylab("Propionate (mmol/kg)") + 
  theme(legend.position = "none")

```

```{r}
# pH
ph <- read_delim("Lab5/curated_data/ph_wkly.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower) %>%
  mutate(semester = factor(semester,
                           levels=c("Winter2015", "Fall2015", 
                                    "Winter2016", "Fall2016", 
                                    "Winter2017", "Fall2017", 
                                    "Winter2018", "Fall2018", 
                                    "Winter2019"), ordered = TRUE))
ph_curated <- ph %>%
  select(-starts_with("use"), 
         -starts_with("stat"), -ends_with("median"),
         -starts_with("comm"),
         -starts_with("n_meas")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS" | supplement_consumed == "LOODAT",
         quantity_compliant == "yes") %>%
    na.omit(ph_mean) #drop any samples with NA in named columns

ph_curated %>%
  filter(study_week == "week1" | study_week == "week3") %>%
  ggplot(aes(x = study_week, 
             y = ph_mean)) + 
  geom_violin() # + geom_jitter()
ph_curated


ggsave2(ph_curated, path = "~/Desktop/UMich_Bio201_F19/figures/")


# Facet Grid (ignore)
ph_curated %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>% 
  ggplot(aes(x = study_week, 
             y = ph_mean, 
             color = study_week), 
         frequency) + 
  geom_violin() + # geom_jitter() + 
  facet_grid(~frequency) + 
  xlab(NULL) + 
  ylab("pH") + 
  theme(legend.position = "none")


```

# Homework 5.3
Check assumptions on data sets for individuals who consumed BRMPS: breath methane, pH, acetate, propionate
```{r}
# breath methane
# n sample size
breath_methane %>%
  filter(study_week == "week1" | study_week == "week3") %>% #subset long data frame in same manner as for plot
  group_by(study_week) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group


# normality
wk1_methane <- breath_methane %>%
  filter(study_week == "week1", 
         supplement_consumed == "BRMPS") 
shapiro.test(wk1_methane$ch4_mean) 

wk3_methane <- breath_methane %>%
  filter(study_week == "week3", 
         supplement_consumed == "BRMPS") 
shapiro.test(wk3_methane$ch4_mean) 


# normality graph incase test did not pass
ggplot(wk1_methane, aes(x=ch4_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value
qqnorm(wk1_methane$ch4_mean); qqline(wk1_methane$ch4_mean)

ggplot(wk3_methane, aes(x=ch4_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value
qqnorm(wk3_methane$ch4_mean); qqline(wk3_methane$ch4_mean)


# equal varience
var.test(x = wk1_methane$ch4_mean, 
         y = wk3_methane$ch4_mean, 
         alternative = "two.sided")
```
#Does not pass varience test, and both do not pass the shapiro test. However, we can roughly assume data sets to be normal from normal QQ plot and large sample size. But certainly proceed with caution.

```{r}
# acetate
# n sample size
acetate_long %>%
  filter(study_week == "week1" | study_week == "week3") %>% #subset long data frame in same manner as for plot
  group_by(study_week) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group

# normality
wk1_acetate <- acetate_long %>%
  filter(study_week == "week1", 
         supplement_consumed == "BRMPS") 
shapiro.test(wk1_acetate$acetate_mean) 

wk3_acetate <- acetate_long %>%
  filter(study_week == "week3", 
         supplement_consumed == "BRMPS") 
shapiro.test(wk3_acetate$acetate_mean) 

# normality graph incase test did not pass
ggplot(wk1_acetate, aes(x=acetate_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value
qqnorm(wk1_acetate$acetate_mean); qqline(wk1_acetate$acetate_mean)

ggplot(wk3_acetate, aes(x=acetate_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value
qqnorm(wk3_acetate$acetate_mean); qqline(wk3_acetate$acetate_mean)


# equal varience
var.test(x = wk1_acetate$acetate_mean, 
         y = wk3_acetate$acetate_mean, 
         alternative = "two.sided")
```
#Neither data set passes shapiro test but large sample sizes, histograms, and qq normality plots otherwise indicate that the data for bothe sets is approximately normal and thus it is reasonable to assume it to be normal. 

```{r}
# propionate
# n sample size
propionate_long %>%
  filter(study_week == "week1" | study_week == "week3") %>% #subset long data frame in same manner as for plot
  group_by(study_week) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group

# normality
wk1_propionate <- propionate_long %>%
  filter(study_week == "week1", 
         supplement_consumed == "BRMPS") 
shapiro.test(wk1_propionate$propionate_mean) 

wk3_propionate <- propionate_long %>%
  filter(study_week == "week3", 
         supplement_consumed == "BRMPS") 
shapiro.test(wk3_propionate$propionate_mean)

# normality graph incase test did not pass
ggplot(wk1_propionate, aes(x=propionate_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value
qqnorm(wk1_propionate$propionate_mean); qqline(wk1_propionate$propionate_mean)

ggplot(wk3_propionate, aes(x=propionate_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value
qqnorm(wk3_propionate$propionate_mean); qqline(wk3_propionate$propionate_mean)

# equal varience
var.test(x = wk1_propionate$propionate_mean, 
         y = wk3_propionate$propionate_mean, 
         alternative = "two.sided")
```
#Both do not pass varience test or shapiro test. However, large sample size, histogram, and the normal QQ plot all indicate that the data for both weeks appears to be approximately normal, and thus we can reasonably assume the conditions are roughly meant. Just proceed with caution.

```{r}
# pH
# n sample size
ph_curated %>%
  filter(study_week == "week1" | study_week == "week3") %>% #subset long data frame in same manner as for plot
  group_by(study_week) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group

# normality
wk1_ph <- ph_curated %>%
  filter(study_week == "week1", 
         supplement_consumed == "BRMPS") 
shapiro.test(wk1_ph$ph_mean) 

wk3_ph <- ph_curated %>%
  filter(study_week == "week3", 
         supplement_consumed == "BRMPS") 
shapiro.test(wk3_ph$ph_mean)


# normality graph incase test did not pass
ggplot(wk1_ph, aes(x=ph_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value
qqnorm(wk1_ph$ph_mean); qqline(wk1_ph$ph_mean)

ggplot(wk3_ph, aes(x=ph_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value
qqnorm(wk3_ph$ph_mean); qqline(wk3_ph$ph_mean)


# equal varience
var.test(x = wk1_ph$ph_mean, 
         y = wk3_ph$ph_mean, 
         alternative = "two.sided")
```
#Week3 does not pass shapiro test and the data does not pass the varience test. However, large sample size, histogram, and the normal QQ plot all indicate that the data appears to be approximately normal, and thus we can reasonably assume the conditions are roughly meant. Just proceed with caution.

# Homework 5.4
Conduct the appropriate statistical tests to determine if patterns observed in plots are significant. Write your interpretations of the results as a comment after the statistical tests.
```{r}
# breath methane
methane_df <- inner_join(x = wk1_methane, y = wk3_methane,
                    by = c("participant_id", 
                           "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(methane_mean_wk1 = ch4_mean.x,
         methane_mean_wk3 = ch4_mean.y) %>%
  select(-starts_with("study_week"))

# use groups extracted above for the test 
t.test(x = methane_df$methane_mean_wk1, 
       y = methane_df$methane_mean_wk3,
       alternative = "less", paired = TRUE, var.equal = FALSE )
```
The p-value for the breath methane is extremely low (.008591) meaning that we have significant evidence to reject the null hypothesis since this tells us that there is a 0.8591% chance we could get these data if the null hypothesis is true, which is extremely unprobable. Thus, we reject the null hypothesis that BRMPS had no effect on the amount of methane gas produced by the individuals' microbiomes, and accept the alternative hypothesis that taking a BRMPS supplement does raise the amount of methane produced in the microbiome.

```{r}
# acetate
acetate_df <- inner_join(x = wk1_acetate, y = wk3_acetate,
                    by = c("participant_id", 
                           "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(acetate_mean_wk1 = acetate_mean.x,
         acetate_mean_wk3 = acetate_mean.y) %>%
  select(-starts_with("study_week"))

# use groups extracted above for the test 
t.test(x = acetate_df$acetate_mean_wk1, 
       y = acetate_df$acetate_mean_wk3,
       alternative = "less", paired = TRUE, var.equal = TRUE)
```
The p-value for this t-test between the starting and ending week for individuals taking BRMPS and its effect on acetate production is extremely low (.007261). Thus, if the null hypothesis was true, there would only be a 0.7261% chance that these results for acetate production would occur, which is extremely improbable. Therefore, we can reject the null hypothesis and accept the alternative hypothesis stating that consuming BRMPS does increase the amount of acetate production in the human microbiome.


```{r}
# propionate
propionate_df <- inner_join(x = wk1_propionate, y = wk3_propionate,
                    by = c("participant_id", 
                           "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(propionate_mean_wk1 = propionate_mean.x,
         propionate_mean_wk3 = propionate_mean.y) %>%
  select(-starts_with("study_week"))

# use groups extracted above for the test 
t.test(x = propionate_df$propionate_mean_wk1, 
       y = propionate_df$propionate_mean_wk3,
       alternative = "less", paired = TRUE, var.equal = FALSE )
```
The p-value for this t-test between the starting and ending week for individuals taking BRMPS and its effect on propionate production is fairly high (.3063). Thus there is a 30.63% that we could get these data for propionate production if the null hypothesis is true, which is a great chance. Therefore, we do not have enough evidence to reject the null hypothesis and must accept it, which means that consuming BRMPS has no effect on the propionate production of the human gut microbiome.

```{r}
# pH
ph_df <- inner_join(x = wk1_ph, y = wk3_ph,
                    by = c("participant_id", 
                           "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(ph_mean_wk1 = ph_mean.x,
         ph_mean_wk3 = ph_mean.y) %>%
  select(-starts_with("study_week"))

# use groups extracted above for the test 
t.test(x = ph_df$ph_mean_wk1, 
       y = ph_df$ph_mean_wk3,
       alternative = "greater", paired = TRUE, var.equal = FALSE )
```
The p-value for this t-test between the starting and ending week for individuals taking BRMPS and its effect on ph is pretty low (0.002893). Therefore, there is only a .2893% chance these data regarding ph could occur assuming the null hypothesis was true, or that BRMPS has no effect on gut ph. We have significant data evidence to reject the null hypothesis and accept the alternative hypthesis, meaning that BRMPS consumption does decrease the ph level of the human gut.

# ANOVA
As you know, we have more than two starch groups we would like to analyze. Instead of doing multiple pairwise comparisons with t-tests (which isn't the best approach because of reasons ...) we use an ANOVA, which compares all categorical groups to one another. 

To illustrate when an ANOVA would be useful, use the `scfa_wide` data frame imported above, plot the delta butyrate vs. supplement type. 
```{r}
scfa_wide %>%
  ggplot(aes(x = supplement_consumed,
             y = delta_butyrate,
             color = supplement_consumed)) +
  geom_hline(yintercept = 0,
             linetype = "dashed") + 
  geom_violin() + 
  geom_jitter() + 
  xlab(NULL) +
  ylab("Butyrate mmol/kg (wk3 - wk1)") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

### Check assumptions

As with the t-tests, there are assumptions to check before running an ANOVA. 
```{r}
# check sample sizes
scfa_wide %>%
  group_by(supplement_consumed) %>%
  summarise(sample_size = n())
```

Divide the labor with your neighbors and run the normality check on each of the 12 supplements. The first few have been completed as an example.
```{r}
scfa_wide
# check normality of each group 
s1 <- scfa_wide %>%
  filter(supplement_consumed == "Accessible") 
shapiro.test(s1$delta_butyrate) #p-value = 0.6886

s2 <- scfa_wide %>%
  filter(supplement_consumed == "Arabino") 
shapiro.test(s2$delta_butyrate) #p-value = 0.7785

s3 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS+Accessible")
shapiro.test(s3$delta_butyrate) #p-value = 0.4633

s4 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize") 
shapiro.test(s4$delta_butyrate) #p-value = 0.7113

s5 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize+BRMPS") 
shapiro.test(s5$delta_butyrate) #p-value = 0.6287

s6 <- scfa_wide %>%
  filter(supplement_consumed == "Inulin") 
shapiro.test(s6$delta_butyrate) #p-value = 0.492

#personal work

s7 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium") 
shapiro.test(s7$delta_butyrate) #p-value = 0.2783

s8 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium+BRMPS") 
shapiro.test(s8$delta_butyrate) #p-value = 0.04406

s9 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS") 
shapiro.test(s9$delta_butyrate) #p-value = 0.2537

s10 <- scfa_wide %>%
  filter(supplement_consumed == "none") 
shapiro.test(s10$delta_butyrate) #p-value = 0.009887

s11 <- scfa_wide %>%
  filter(supplement_consumed == "transition_HiMaize") 
shapiro.test(s11$delta_butyrate) #p-value = 0.06542

s12 <- scfa_wide %>%
  filter(supplement_consumed == "LOODAT") 
shapiro.test(s12$delta_butyrate) #p-value = 0.6976
```

```{r}
# check variances 
bartlett.test(delta_butyrate ~ supplement_consumed, data = scfa_wide)
# enter arguments with the following formula: continuous ~ categorical 
```

Now that we know our assumptions are reasonably met, we can run the test: 
```{r}
# run anova
aov_results <- aov(delta_butyrate ~ supplement_consumed, data = scfa_wide)
summary(aov_results)
```


# Homework 5.5
Repeat the processing of checking assumptions to conduct ANOVA on delta acetate and propionate. Create a plot for delta acetate and propionate. Save plots to folder called `figures`. Decide if you should proceed with conducting the ANOVA. Write your interpretations of the results as a comment after the statistical tests.
```{r}
# acetate
scfa_wide %>%
  group_by(supplement_consumed) %>%
  summarise(sample_size = n())

# check normality of each group 
s1 <- scfa_wide %>%
  filter(supplement_consumed == "Accessible") 
shapiro.test(s1$delta_acetate) #p-value = 0.674

s2 <- scfa_wide %>%
  filter(supplement_consumed == "Arabino") 
shapiro.test(s2$delta_acetate) #p-value = 0.05369

s3 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS+Accessible")
shapiro.test(s3$delta_acetate) #p-value = 0.8305

s4 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize") 
shapiro.test(s4$delta_acetate) #p-value = 0.001526

s5 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize+BRMPS") 
shapiro.test(s5$delta_acetate) #p-value = 0.3026

s6 <- scfa_wide %>%
  filter(supplement_consumed == "Inulin") 
shapiro.test(s6$delta_acetate) #p-value = 0.9105

s7 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium") 
shapiro.test(s7$delta_acetate) #p-value = 0.7713

s8 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium+BRMPS") 
shapiro.test(s8$delta_acetate) #p-value = 0.9725

s9 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS") 
shapiro.test(s9$delta_acetate) #p-value = 0.02496

s10 <- scfa_wide %>%
  filter(supplement_consumed == "none") 
shapiro.test(s10$delta_acetate) #p-value = 0.3468

s11 <- scfa_wide %>%
  filter(supplement_consumed == "transition_HiMaize") 
shapiro.test(s11$delta_acetate) #p-value = 0.6092

s12 <- scfa_wide %>%
  filter(supplement_consumed == "LOODAT") 
shapiro.test(s12$delta_acetate) #p-value = 0.137

# check variances 
bartlett.test(delta_acetate ~ supplement_consumed, data = scfa_wide)

# plot
scfa_wide %>%
  ggplot(aes(x = supplement_consumed,
             y = delta_acetate,
             color = supplement_consumed)) +
  geom_hline(yintercept = 0,
             linetype = "dashed") + 
  geom_violin() + 
  geom_jitter() + 
  xlab(NULL) +
  ylab("Acetate mmol/kg (wk3 - wk1)") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggsave2(anova_acetate, path = "~/Desktop/UMich_Bio201_F19/figures/")


#ANOVA Results if applicable
aov_results <- aov(delta_acetate ~ supplement_consumed, data = scfa_wide)
summary(aov_results)
```
Although the assumptions are not met completely, as 5/12 supplement consumed data sets do not meet the ideal sample size of equal to or greater than 30, 2 have p-values of less than .05 for the normality test (thus the alternative hypothesis that they are not normal is true), and the p-value for the varience test is quite small (less than .01); yet it is not completely unreasonable to conduct an ANOVA test because a lot of the data is approximately normal. In doing this, we must certainly proceed with caution. The low F value (which is very close to one) indicates that we do not have significant evidence to reject the null hypothesis. Thus we must accept the null hypothesis stating that the mean difference in acetate concentration between week 1 and week 3 for all supplements consumed are equal. In other words, taking a different supplement (of the ones given in the study) will not have a different effect on the human microbiome than another supplement given in the study.


```{r}
scfa_wide
# propionate
scfa_wide %>%
  group_by(supplement_consumed) %>%
  summarise(sample_size = n())

# check normality of each group 
s1 <- scfa_wide %>%
  filter(supplement_consumed == "Accessible") 
shapiro.test(s1$delta_propionate) #p-value = 0.6.507e-05

#Test is not working (sample size too small?)
s2 <- scfa_wide %>%
  filter(supplement_consumed == "Arabino") 
shapiro.test(s2$delta_propionate) #p-value = not applicable because sample size is too low

s3 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS+Accessible")
shapiro.test(s3$delta_propionate) #p-value = 0.0.2266

s4 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize") 
shapiro.test(s4$delta_propionate) #p-value = 0.2669

s5 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize+BRMPS") 
shapiro.test(s5$delta_propionate) #p-value = 0.4316

s6 <- scfa_wide %>%
  filter(supplement_consumed == "Inulin") 
shapiro.test(s6$delta_propionate) #p-value = 0.8973

s7 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium") 
shapiro.test(s7$delta_propionate) #p-value = 0.1115

s8 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium+BRMPS") 
shapiro.test(s8$delta_propionate) #p-value = 0.6636

s9 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS") 
shapiro.test(s9$delta_propionate) #p-value = 0.6.47e-06

s10 <- scfa_wide %>%
  filter(supplement_consumed == "none") 
shapiro.test(s10$delta_propionate) #p-value = 0.1025

s11 <- scfa_wide %>%
  filter(supplement_consumed == "transition_HiMaize") 
shapiro.test(s11$delta_propionate) #p-value = 0.4711

s12 <- scfa_wide %>%
  filter(supplement_consumed == "LOODAT") 
shapiro.test(s12$delta_propionate) #p-value = 0.8389

# check variances 
bartlett.test(delta_propionate ~ supplement_consumed, data = scfa_wide)

# plot
scfa_wide %>%
  ggplot(aes(x = supplement_consumed,
             y = delta_propionate,
             color = supplement_consumed)) +
  geom_hline(yintercept = 0,
             linetype = "dashed") + 
  geom_violin() + 
  geom_jitter() + 
  xlab(NULL) +
  ylab("Propionate mmol/kg (wk3 - wk1)") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggsave2(anova_propionate, path = "~/Desktop/UMich_Bio201_F19/figures/")

#ANOVA Results if applicable
aov_results <- aov(delta_propionate ~ supplement_consumed, data = scfa_wide)
summary(aov_results)
```
Although the assumptions are not met completely, as 5/12 supplement consumed data sets do not meet the ideal sample size of equal to or greater than 30, 2 have p-values of less than .05 for the normality test (thus the alternative hypothesis that they are not normal is true), and one cannot have normality since the sample size is too small; the p-value for the varience test is also quite small (less than .01). Yet it is not completely unreasonable to conduct an ANOVA test because a lot of data is shows approximate normality. In doing this, we must certainly proceed with caution. Thus we must accept the null hypothesis stating that the mean difference in propionate concentration between week 1 and week 3 for all supplements consumed are equal. In other words, taking a different supplement (of the ones given in the study) will not have a different effect on the human microbiome than another supplement given in the study.

